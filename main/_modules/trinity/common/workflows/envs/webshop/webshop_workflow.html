

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>trinity.common.workflows.envs.webshop.webshop_workflow &mdash; Trinity-RFT 0.2.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../_static/documentation_options.js?v=37f418d5"></script>
      <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../index.html" class="icon icon-home">
            Trinity-RFT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/example_reasoning_basic.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/example_reasoning_advanced.html">Off-Policy RFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/example_megatron.html">Megatron-LM Backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/example_async_mode.html">Asynchronous RFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/example_multi_turn.html">Concatenated Multi-Turn RFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/example_step_wise.html">General Multi-Step RFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/example_react.html">Multi-Step ReAct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/example_search_email.html">Email Search Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/example_dpo.html">Offline DPO and SFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/example_data_functionalities.html">Data Processing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guidelines</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/trinity_programming_guide.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/trinity_configs.html">Configuration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/example_mix_algo.html">Algorithm Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/synchronizer.html">Synchronizer in Trinity-RFT</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/faq.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../api_reference.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">Trinity-RFT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">trinity.common.workflows.envs.webshop.webshop_workflow</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for trinity.common.workflows.envs.webshop.webshop_workflow</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">trinity.common.experience</span><span class="w"> </span><span class="kn">import</span> <span class="n">Experience</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">trinity.common.models.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelWrapper</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">trinity.common.workflows.workflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">WORKFLOWS</span><span class="p">,</span> <span class="n">MultiTurnWorkflow</span><span class="p">,</span> <span class="n">Task</span>

<span class="n">SPARSE_REWARD</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">EXAMPLE_PROMPT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Observation:</span>
<span class="s2">Webshop</span>
<span class="s2">Instruction:</span>
<span class="s2">i would like a 3 ounce bottle of bright citrus deodorant for sensitive skin, and price lower than 50.00 dollars</span>
<span class="s2">[button] Search [button_]</span>

<span class="s2">Response:</span>
<span class="s2">&lt;think&gt;OK, let&#39;s search for 3 ounce bright citrus deodorant sensitive skin&lt;/think&gt;&lt;action&gt;search[3 ounce bright citrus deodorant sensitive skin]&lt;/action&gt;</span>

<span class="s2">Observation:</span>
<span class="s2">Instruction:</span>
<span class="s2">i would like a 3 ounce bottle of bright citrus deodorant for sensitive skin, and price lower than 50.00 dollars</span>
<span class="s2">[button] Back to Search [button_]</span>
<span class="s2">Page 1 (Total results: 50)</span>
<span class="s2">[button] Next &gt; [button_]</span>
<span class="s2">[button] B078GWRC1J [button_]</span>
<span class="s2">Bright Citrus Deodorant by Earth Mama | Natural and Safe for Sensitive Skin, Pregnancy and Breastfeeding, Contains Organic Calendula 3-Ounce</span>
<span class="s2">$10.99</span>
<span class="s2">[button] B078GTKVXY [button_]</span>
<span class="s2">Ginger Fresh Deodorant by Earth Mama | Natural and Safe for Sensitive Skin, Pregnancy and Breastfeeding, Contains Organic Calendula 3-Ounce</span>
<span class="s2">$10.99</span>
<span class="s2">[button] B08KBVJ4XN [button_]</span>
<span class="s2">Barrel and Oak - Aluminum-Free Deodorant, Deodorant for Men, Essential Oil-Based Scent, 24-Hour Odor Protection, Cedar &amp; Patchouli Blend, Gentle on Sensitive Skin (Mountain Sage, 2.7 oz, 2-Pack)</span>
<span class="s2">$15.95</span>

<span class="s2">Response:</span>
<span class="s2">&lt;think&gt;button B078GWRC1J and B078GTKVXY are bright citrus deodorant less then 50 dollars. I can check B078GWRC1J first&lt;/think&gt;&lt;action&gt;click[B078GWRC1J]&lt;/action&gt;</span>

<span class="s2">Observation:</span>
<span class="s2">Instruction:</span>
<span class="s2">i would like a 3 ounce bottle of bright citrus deodorant for sensitive skin, and price lower than 50.00 dollars</span>
<span class="s2">[button] Back to Search [button_]</span>
<span class="s2">[button] &lt; Prev [button_]</span>
<span class="s2">scent [button] assorted scents [button_][button] bright citrus [button_][button] calming lavender [button_][button] ginger fresh [button_][button] simply non-scents [button_]</span>
<span class="s2">size [button] travel set (4-pack) [button_][button] 3 ounce (pack of 1) [button_][button] 3-ounce (2-pack) [button_]</span>
<span class="s2">Bright Citrus Deodorant by Earth Mama | Natural and Safe for Sensitive Skin, Pregnancy and Breastfeeding, Contains Organic Calendula 3-Ounce</span>
<span class="s2">Price: $10.99</span>
<span class="s2">Rating: N.A.</span>
<span class="s2">[button] Description [button_]</span>
<span class="s2">[button] Features [button_]</span>
<span class="s2">[button] Reviews [button_]</span>
<span class="s2">[button] Buy Now [button_]</span>

<span class="s2">Response:</span>
<span class="s2">&lt;think&gt;For 3 ounce bottle of bright citrus deodorant for sensitive skin, the item has options &#39;bright citrus&#39; and &#39;3 ounce (pack of 1)&#39; and seems good to buy. &lt;/think&gt;&lt;action&gt;click[bright citrus]&lt;/action&gt;</span>

<span class="s2">Observation:</span>
<span class="s2">You have clicked bright citrus.</span>
<span class="s2">...</span>

<span class="s2">Response:</span>
<span class="s2">&lt;think&gt;Now I should select the 3 ounce (pack of 1) option&lt;/think&gt;&lt;action&gt;click[3 ounce (pack of 1)]&lt;/action&gt;</span>

<span class="s2">Observation:</span>
<span class="s2">You have clicked 3 ounce (pack of 1).</span>
<span class="s2">...</span>

<span class="s2">Response:</span>
<span class="s2">&lt;think&gt;I can buy the item&lt;/think&gt;&lt;action&gt;click[Buy Now]&lt;/action&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="n">WebShop_SYSTEM_PROMPT_WITH_EXAMPLE</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">You are an agent interacting with a virtual text-based web shopping environment to test out your ability. Your job is to find follow the Instruction provided and mimic the steps to buy the item that are closest to the Instruct provided.</span>

<span class="s2">## Action Format:</span>
<span class="s2">You should give both the action_name and action_arg like the format `action_name[action_arg]`. You can execute two types of actions, search and click.</span>
<span class="s2">- When the button `[button] Search [button_]` is available in the current observation, you can execute the action &lt;action&gt;search[xxx]&lt;/action&gt; (you should type the query you want to search in the square brackets here).</span>
<span class="s2">- You can click buttons `[button] xxx [button_]` that is available in the current observation, by execute the action &lt;action&gt;click[xxx]&lt;/action&gt;.</span>

<span class="s2">Below are some examples of action formats.</span>
<span class="s2">- &lt;action&gt;search[white shoes]&lt;/action&gt;</span>
<span class="s2">- &lt;action&gt;click[Buy Now]&lt;/action&gt;</span>

<span class="s2">## Example:</span>
<span class="s2">Here is an example:</span>
<span class="s2">```</span>
<span class="si">{</span><span class="n">EXAMPLE_PROMPT</span><span class="si">}</span>
<span class="s2">```</span>

<span class="s2">## Notes:</span>
<span class="s2">At each step, you should first think then perform action to fulfill the instruction. You should ALWAYS wrap your thinking with the &lt;think&gt; &lt;/think&gt; tag and wrap your action with the &lt;action&gt; &lt;/action&gt; tag.</span>
<span class="s2">You should ALWAYS take one action each step.</span>
<span class="s2">You should finish the task and buy the item within 15 steps.</span>
<span class="s2">DONOT try to interact with the user at anytime. Finish the task and buy the item by yourself.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">WebShop_SYSTEM_PROMPT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">You are an agent interacting with a virtual text-baed web shopping environments to testout your ability. Your job is to find follow the Instruction provided and mimic the steps to buy the item that are closest to the Instruct provided.</span>

<span class="s2">## Action Format:</span>
<span class="s2">You should give both the action_name and action_arg like the format `action_name[action_arg]`. You can execute two types of actions, search and click.</span>
<span class="s2">- When the button `[button] Search [button_]` is available in the current observation, you can execute the action &lt;action&gt;search[xxx]&lt;/action&gt; (you should type the query you want to search in the square brackets here).</span>
<span class="s2">- You can click buttons `[button] xxx [button_]` that is available in the current observation, by execute the action &lt;action&gt;click[xxx]&lt;/action&gt;.</span>

<span class="s2">Below are some examples of action formats.</span>
<span class="s2">- &lt;action&gt;search[white shoes]&lt;/action&gt;</span>
<span class="s2">- &lt;action&gt;click[Buy Now]&lt;/action&gt;</span>

<span class="s2">## Notes:</span>
<span class="s2">At each step, you should first think then perform action to fulfill the instruction. You should ALWAYS wrap your thinking with the &lt;think&gt; &lt;/think&gt; tag and wrap your action with the &lt;action&gt; &lt;/action&gt; tag.</span>
<span class="s2">You should ALWAYS take one action each step.</span>
<span class="s2">You should finish the task and buy the item within 15 steps.</span>
<span class="s2">DONOT try to interact with the user at anytime. Finish the task and buy the item by yourself.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">format_observation</span><span class="p">(</span><span class="n">observation</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;Observation: &quot;</span> <span class="o">+</span> <span class="n">observation</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_action</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># parse the action within the &lt;action&gt; &lt;/action&gt; tag</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;action&gt;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;/action&gt;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">action</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error parsing action:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">validate_action</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">available_actions</span><span class="p">):</span>
    <span class="c1"># parse action name and args</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.+)\[(.+)\]&quot;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">action_name</span> <span class="o">=</span> <span class="n">action</span>
        <span class="n">action_arg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">action_name</span><span class="p">,</span> <span class="n">action_arg</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">action_arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">action_arg</span> <span class="o">=</span> <span class="n">action_arg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="c1"># for correct action format</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">action_name</span> <span class="o">==</span> <span class="s2">&quot;search&quot;</span>
        <span class="ow">and</span> <span class="n">action_arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="ow">and</span> <span class="n">action_arg</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
        <span class="ow">and</span> <span class="n">available_actions</span><span class="p">[</span><span class="s2">&quot;has_search_bar&quot;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
    <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s2">&quot;click&quot;</span> <span class="ow">and</span> <span class="n">action_arg</span> <span class="ow">in</span> <span class="n">available_actions</span><span class="p">[</span><span class="s2">&quot;clickables&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
    <span class="c1"># for incorrect action format</span>
    <span class="k">if</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s2">&quot;search&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action_arg</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="n">action_arg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;Invalid action, please type in the query you want to search in the square brackets here.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;Can not perfrom search action without search bar. Please click the Back to Search button first.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s2">&quot;click&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action_arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_actions</span><span class="p">[</span><span class="s2">&quot;clickables&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Incorrect action format, make sure you have the correct button name that is **within the current page**. The buttons you can click now are: </span><span class="si">{</span><span class="n">available_actions</span><span class="p">[</span><span class="s1">&#39;clickables&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Invalid action. You should wrap your action with the &lt;action&gt; &lt;/action&gt; tag and follow the action format.&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<div class="viewcode-block" id="WebShopWorkflow">
<a class="viewcode-back" href="../../../../../../build_api/trinity.common.workflows.html#trinity.common.workflows.WebShopWorkflow">[docs]</a>
<span class="nd">@WORKFLOWS</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="s2">&quot;webshop_workflow&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">WebShopWorkflow</span><span class="p">(</span><span class="n">MultiTurnWorkflow</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A workflow for webshop task.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="WebShopWorkflow.__init__">
<a class="viewcode-back" href="../../../../../../build_api/trinity.common.workflows.html#trinity.common.workflows.WebShopWorkflow.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">ModelWrapper</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span>
        <span class="n">auxiliary_models</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_env_steps</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="c1"># TODO: Make parallel envs</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">gym</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">web_agent_site.envs</span><span class="w"> </span><span class="kn">import</span> <span class="n">WebAgentTextEnv</span>  <span class="c1"># noqa: F401</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please make sure you have installed the web_agent_site package.&quot;</span><span class="p">)</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error importing WebAgentTextEnv </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">. Please make sure you have installed the web_agent_site package, following the instructions in https://github.com/princeton-nlp/WebShop&quot;</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Making GYM env&quot;</span><span class="p">)</span>
        <span class="c1"># NOTE: Hosting the env require ~15GB CPU memory.</span>
        <span class="c1"># If you want easier env, you can set the num_products to 1000 or 100000.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span>
            <span class="s2">&quot;WebAgentTextEnv-v0&quot;</span><span class="p">,</span> <span class="n">observation_mode</span><span class="o">=</span><span class="s2">&quot;text_rich&quot;</span><span class="p">,</span> <span class="n">num_products</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">human_goals</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">resettable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="WebShopWorkflow.reset">
<a class="viewcode-back" href="../../../../../../build_api/trinity.common.workflows.html#trinity.common.workflows.WebShopWorkflow.reset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_desc</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">task_desc</span> <span class="ow">or</span> <span class="s2">&quot;0&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repeat_times</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">repeat_times</span></div>


<div class="viewcode-block" id="WebShopWorkflow.get_model_response">
<a class="viewcode-back" href="../../../../../../build_api/trinity.common.workflows.html#trinity.common.workflows.WebShopWorkflow.get_model_response">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_model_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">responses</span></div>


<div class="viewcode-block" id="WebShopWorkflow.get_model_response_text">
<a class="viewcode-back" href="../../../../../../build_api/trinity.common.workflows.html#trinity.common.workflows.WebShopWorkflow.get_model_response_text">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_model_response_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_response</span><span class="p">(</span><span class="n">messages</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">response_text</span></div>


<div class="viewcode-block" id="WebShopWorkflow.generate_env_inference_samples">
<a class="viewcode-back" href="../../../../../../build_api/trinity.common.workflows.html#trinity.common.workflows.WebShopWorkflow.generate_env_inference_samples">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_env_inference_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">rollout_num</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Experience</span><span class="p">]:</span>
        <span class="c1"># TODO: Make this parallel</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating env inference samples...&quot;</span><span class="p">)</span>
        <span class="n">experience_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rollout_num</span><span class="p">):</span>
            <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session_id</span><span class="p">)</span>
            <span class="n">final_reward</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
            <span class="n">observation</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">observation</span>
            <span class="n">memory</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">memory</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">WebShop_SYSTEM_PROMPT</span><span class="p">})</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_env_steps</span><span class="p">):</span>
                <span class="n">available_actions</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_available_actions</span><span class="p">()</span>
                <span class="n">format_obs</span> <span class="o">=</span> <span class="n">format_observation</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
                <span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span> <span class="o">+</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">format_obs</span><span class="p">}]</span>
                <span class="n">response_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_response_text</span><span class="p">(</span><span class="n">memory</span><span class="p">)</span>
                <span class="n">memory</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">response_text</span><span class="p">})</span>
                <span class="n">action</span> <span class="o">=</span> <span class="n">parse_action</span><span class="p">(</span><span class="n">response_text</span><span class="p">)</span>
                <span class="n">action_valid</span><span class="p">,</span> <span class="n">error_msg</span> <span class="o">=</span> <span class="n">validate_action</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">available_actions</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">action_valid</span><span class="p">:</span>
                    <span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">observation</span> <span class="o">=</span> <span class="n">error_msg</span>
                    <span class="n">reward</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                    <span class="n">final_reward</span> <span class="o">=</span> <span class="n">reward</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">SPARSE_REWARD</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">final_reward</span> <span class="o">&gt;=</span> <span class="mf">0.99</span><span class="p">:</span>
                    <span class="n">final_reward</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">final_reward</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">final_reward</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">final_reward</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
            <span class="n">experience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_messages_to_experience</span><span class="p">(</span>
                <span class="n">memory</span><span class="p">,</span>
                <span class="n">final_reward</span><span class="p">,</span>
                <span class="p">{</span><span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="n">session_id</span><span class="p">,</span> <span class="s2">&quot;env_rounds&quot;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s2">&quot;env_done&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">done</span> <span class="k">else</span> <span class="mi">0</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="n">experience_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">experience</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">experience_list</span></div>


<div class="viewcode-block" id="WebShopWorkflow.run">
<a class="viewcode-back" href="../../../../../../build_api/trinity.common.workflows.html#trinity.common.workflows.WebShopWorkflow.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Experience</span><span class="p">]:</span>
        <span class="c1"># assume the task_description is the session_id generated.</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_desc</span><span class="p">)</span>
        <span class="n">rollout_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat_times</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_env_inference_samples</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">rollout_n</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Trinity-RFT Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    <b>main</b>
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Branches</dt>
      <dd><b><a href="webshop_workflow.html">main</a> (latest)</b></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>