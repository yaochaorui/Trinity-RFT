

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Processing &mdash; Trinity-RFT 0.2.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=37f418d5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Developer Guide" href="trinity_programming_guide.html" />
    <link rel="prev" title="Offline DPO and SFT" href="example_dpo.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Trinity-RFT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="example_reasoning_basic.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_reasoning_advanced.html">Off-Policy RFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_async_mode.html">Asynchronous RFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_multi_turn.html">Concatenated Multi-Turn RFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_step_wise.html">General Multi-Step RFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_react.html">Multi-Step ReAct</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_search_email.html">Email Search Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_dpo.html">Offline DPO and SFT</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Data Processing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-data-processor-for-task-pipeline">Example: Data Processor for Task Pipeline</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#configure-the-data-processor">Configure the Data Processor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exploring-training">Exploring &amp; Training</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#example-data-processor-for-experience-pipeline">Example: Data Processor for Experience Pipeline</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#data-processor-server-preparation">Data Processor Server Preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">Configure the Data Processor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">Exploring &amp; Training</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#example-human-in-the-loop">Example: Human in the Loop</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">Configure the Data Processor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#start-running">Start Running</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guidelines</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="trinity_programming_guide.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="trinity_configs.html">Configuration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_mix_algo.html">Algorithm Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="synchronizer.html">Synchronizer in Trinity-RFT</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_reference.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Trinity-RFT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Data Processing</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/modelscope/Trinity-RFT/blob/main/docs/sphinx_doc/source/tutorial/example_data_functionalities.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="data-processing">
<span id="id1"></span><h1>Data Processing<a class="headerlink" href="#data-processing" title="Link to this heading"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>Trinity-RFT provides a unified data processor to process the raw dataset and experiences for the task pipeline and the experience pipeline.</p>
<ul class="simple">
<li><p>For tasks, the data processing capabilities come from <a class="reference external" href="https://github.com/modelscope/data-juicer">Data-Juicer</a>. You can use data processing operators from Data-Juicer. The full list of Data-Juicer operators can be found <a class="reference external" href="https://modelscope.github.io/data-juicer/en/main/docs/Operators.html">here</a></p></li>
<li><p>For experiences, in addition to Data-Juicer operators, Trinity-RFT provides several RFT-related operators and allows developers to implement their own operators.</p></li>
</ul>
<p>For implementing your own data processor, you can refer to this <a class="reference internal" href="trinity_programming_guide.html#operators-for-data-developers"><span class="std std-ref">document</span></a>.</p>
<p>To support the data processing of Data-Juicer and RFT-related operators, Trinity-RFT wraps the Data-Juicer operators into a unified service, which can be started automatically. The <code class="docutils literal notranslate"><span class="pre">DataJuicerOperator</span></code> uses a client to send requests of task or experience processing to the server.</p>
<p>An overview of the data processor is shown in the following figure.</p>
<div align="center">
  <img src="https://img.alicdn.com/imgextra/i2/O1CN01BfeHp61sXSlGjH7zQ_!!6000000005776-2-tps-1734-473.png" alt="Trinity-RFT Data Processor">
</div>
</section>
<section id="example-data-processor-for-task-pipeline">
<h2>Example: Data Processor for Task Pipeline<a class="headerlink" href="#example-data-processor-for-task-pipeline" title="Link to this heading"></a></h2>
<p>In this example, you will learn how to apply the data processor of Trinity-RFT to prepare and prioritize the dataset before task exploring and training. This example takes GSM-8K dataset as the example dataset to figure out:</p>
<ol class="arabic simple">
<li><p>how to prepare the data processor</p></li>
<li><p>how to configure the data processor</p></li>
<li><p>what the data processor can do</p></li>
</ol>
<p>Before getting started, you need to prepare the main environment of Trinity-RFT according to the <a class="reference internal" href="example_reasoning_basic.html"><span class="std std-doc">installation section of Quickstart</span></a>,
and store the base url and api key in the environment variables <code class="docutils literal notranslate"><span class="pre">OPENAI_BASE_URL</span></code> and <code class="docutils literal notranslate"><span class="pre">OPENAI_API_KEY</span></code> for some agentic or API-model usages if necessary.</p>
<p>Besides, for starting the data processor server automatically, you also need to install the dependencies in the <code class="docutils literal notranslate"><span class="pre">data</span></code> split.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;.[data]&quot;</span>
</pre></div>
</div>
<section id="configure-the-data-processor">
<h3>Configure the Data Processor<a class="headerlink" href="#configure-the-data-processor" title="Link to this heading"></a></h3>
<p>Trinity-RFT uses a unified config file to manage all config items. For the data processor, you need to focus on the <code class="docutils literal notranslate"><span class="pre">data_processor</span></code> section in the config file.</p>
<p>In this example, assume that you need to rank all math questions and corresponding answers by their difficulties. So you can set these config items like the following example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">data_processor</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># task pipeline related</span>
<span class="w">  </span><span class="nt">task_pipeline</span><span class="p">:</span>
<span class="w">    </span><span class="nt">num_process</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span>
<span class="w">    </span><span class="nt">operators</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;llm_difficulty_score_filter&quot;</span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span>
<span class="w">          </span><span class="nt">api_or_hf_model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;qwen2.5-7b-instruct&quot;</span>
<span class="w">          </span><span class="nt">min_score</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
<span class="w">          </span><span class="nt">input_keys</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;question&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;answer&quot;</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">field_names</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;Question&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;Answer&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">inputs</span><span class="p">:</span><span class="w">  </span><span class="c1"># the output will be set to the explorer input automatically</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/PATH/TO/GSM8K/DATA/FILE</span>
<span class="w">    </span><span class="nt">target_fields</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;question&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;answer&quot;</span><span class="p p-Indicator">]</span>
<span class="nt">service</span><span class="p">:</span>
<span class="w">  </span><span class="nt">data_juicer</span><span class="p">:</span>
<span class="w">    </span><span class="nt">auto_start</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>Here you can set the input files for the GSM-8K dataset and some other items about task pipeline:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">task_pipeline</span></code>: the configs for the task pipeline. Task pipeline is used to process the raw dataset. It consists of several inner configs:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">num_process</span></code>: the number of processes to use for the task pipeline.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">operators</span></code>: the operators used in the task pipeline. All of them are Data-Juicer operators.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">inputs</span></code>: the input files for the task pipeline. We usually load from raw dataset files in this pipeline. It allows multiple inputs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">target_fields</span></code>: the target fields in the dataset to process and be outputted to the result dataset files</p></li>
</ul>
</li>
</ul>
<p>It’s worth noticing that we don’t need to set the output path usually, cause it will be set to the path of the explorer input automatically.</p>
<p>The data processing of Data-Juicer is maintained as a service. Thus we need to config the data-juicer service.
Luckily, Trinity-RFT provides an auto-start way to start the data processor server automatically. All you need to do is to set the <code class="docutils literal notranslate"><span class="pre">auto_start</span></code> of <code class="docutils literal notranslate"><span class="pre">data-juicer</span></code> service to <code class="docutils literal notranslate"><span class="pre">true</span></code> in the <code class="docutils literal notranslate"><span class="pre">service</span></code> section.</p>
<p>All config items in the <code class="docutils literal notranslate"><span class="pre">data_processor</span></code> section can be found <a class="reference internal" href="trinity_configs.html"><span class="std std-doc">here</span></a>. A prepared config file for this example of GSM-8K can be found in <a class="reference external" href="https://github.com/modelscope/Trinity-RFT/tree/main/examples/grpo_gsm8k_task_pipeline/gsm8k.yaml">the config file</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only when one of <code class="docutils literal notranslate"><span class="pre">xxx_pipeline</span></code> is provided, and one of <code class="docutils literal notranslate"><span class="pre">dj_process_desc</span></code> and <code class="docutils literal notranslate"><span class="pre">dj_config_path</span></code> in the pipeline config is provided, the data processor and the data active iterator will be activated. Otherwise, this part will be skipped and it will enter into the exploring stage directly.</p>
</div>
</section>
<section id="exploring-training">
<h3>Exploring &amp; Training<a class="headerlink" href="#exploring-training" title="Link to this heading"></a></h3>
<p>After preparing the config files of Trinity-RFT, you can start your ray cluster and run the RFT process including the data active iterator part with the following commands:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># start the ray cluster</span>
<span class="c1"># on master node</span>
ray<span class="w"> </span>start<span class="w"> </span>--head
<span class="c1"># on worker nodes</span>
ray<span class="w"> </span>start<span class="w"> </span>--address<span class="o">=</span>&lt;master_address&gt;

<span class="c1"># run RFT</span>
trinity<span class="w"> </span>run<span class="w"> </span>--config<span class="w"> </span>&lt;Trinity-RFT_config_path&gt;
</pre></div>
</div>
<p>If you follow the steps above, Trinity-RFT will send a request to the data processor server, the data active iterator will be activated, compute difficulty scores for each sample in the raw dataset, and rank the dataset according to difficulty scores. After that, the data processor server stores the result dataset into the output buffer, when exploring begins, it will load the prepared dataset and continue the downstream steps.</p>
</section>
</section>
<section id="example-data-processor-for-experience-pipeline">
<h2>Example: Data Processor for Experience Pipeline<a class="headerlink" href="#example-data-processor-for-experience-pipeline" title="Link to this heading"></a></h2>
<p>In this example, you will learn how to apply the data processor of Trinity-RFT to reshape rewards of experiences after exploring. This example takes GSM-8K dataset as the example dataset to figure out how to reshape rewards of experiences from the explorer before sent to the trainer from a view of the quality of generated responses.</p>
<p>In addition to the automatic way to start the data processor server in the previous example, you can also start it manually.</p>
<p>Before getting started, you need to prepare the main environment of Trinity-RFT according to the <a class="reference internal" href="example_reasoning_basic.html"><span class="std std-doc">installation section of Quickstart</span></a>,
and store the base url and api key in the environment variables <code class="docutils literal notranslate"><span class="pre">OPENAI_BASE_URL</span></code> and <code class="docutils literal notranslate"><span class="pre">OPENAI_API_KEY</span></code> for some agentic or API-model usages if necessary.</p>
<section id="data-processor-server-preparation">
<h3>Data Processor Server Preparation<a class="headerlink" href="#data-processor-server-preparation" title="Link to this heading"></a></h3>
<p>As the overall framework of Trinity-RFT shows, the data processor is one of the high-level functions. Trinity-RFT also encapsulates the data processor as an independent service to avoid implicit dependency conflict issues.
Thus you can prepare a split environment for it and start the server manually using the prepared scripts.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># prepare split environments, including the one of data processor</span>
python<span class="w"> </span>scripts/install.py

<span class="c1"># start all split servers</span>
python<span class="w"> </span>scripts/start_servers.py
</pre></div>
</div>
<p>These scripts will create split environments for Trinity-RFT and Data-Juicer-based data processor.
Then it will start the data processor server automatically in the Data-Juicer environment.</p>
</section>
<section id="id2">
<h3>Configure the Data Processor<a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<p>In this example, assume that you need to add an extra reward item to the experiences outputted by the explorer, which access the quality scores of the experiences. So you can set the <code class="docutils literal notranslate"><span class="pre">experience_pipeline</span></code> config like the following example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">service</span><span class="p">:</span>
<span class="w">  </span><span class="nt">data_juicer</span><span class="p">:</span>
<span class="w">    </span><span class="nt">server_url</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;http://127.0.0.1:5005&#39;</span>
<span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5005</span>
<span class="nt">data_processor</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># experience pipeline related</span>
<span class="w">  </span><span class="nt">experience_pipeline</span><span class="p">:</span>
<span class="w">    </span><span class="nt">operators</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data_juicer</span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span>
<span class="w">          </span><span class="nt">config_path</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;examples/grpo_gsm8k_experience_pipeline/dj_scoring_exp.yaml&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reward_shaping_mapper</span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span>
<span class="w">          </span><span class="nt">reward_shaping_configs</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">stats_key</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;llm_quality_score&#39;</span>
<span class="w">              </span><span class="nt">op_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ADD</span>
<span class="w">              </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
<span class="w">    </span><span class="nt">save_input</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
<p>Here you can set the information of the started data processor server.
Different from the previous example, which starts the server automatically,
here you need to set the <code class="docutils literal notranslate"><span class="pre">server_url</span></code> and <code class="docutils literal notranslate"><span class="pre">port</span></code> manually according to data processor service started in the previous step.</p>
<p>For the data processor part, you need to config the experience pipeline and some other items about reward shaping:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">experience_pipeline</span></code>: the configs for the experience pipeline. Experience pipeline is used to process the experiences outputted by the explorer, such as reward shaping, data filtering and augmentation. It consists of several inner configs:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">operators</span></code>: the operators used in the experience pipeline.</p>
<ul>
<li><p>Here we use a “data_juicer” operator to compute extra stats and use a “reward_shaping_mapper” operator to reshape rewards according to the computed stats.</p></li>
<li><p>The actual configs for the “data_juicer” operator are stored in another file “examples/grpo_gsm8k_experience_pipeline/dj_scoring_exp.yaml”, which will be introduced later.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">save_input</span></code>: whether to save the input experiences to the disk. Here we set it to false for simplicity.</p></li>
</ul>
</li>
</ul>
<p>In default, the experiences are generated by the explorer and sent to experience pipeline. After processed, they are outputted to the trainer.
So we don’t need to set the input and output buffers for the experience pipeline usually.</p>
<p>In addition, there are several config items for data-juicer operator in <code class="docutils literal notranslate"><span class="pre">experience_pipeline</span></code> part, which is used to compute stats used to reshape rewards. The data-juicer config used here is:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is a Data-Juicer data processing recipe</span>
<span class="nt">project_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;gsm-8k-experience-quality&#39;</span>

<span class="nt">np</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span>

<span class="nt">process</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">llm_quality_score_filter</span><span class="p">:</span>
<span class="w">      </span><span class="nt">api_or_hf_model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;qwen2.5-32b-instruct&quot;</span><span class="w">  </span><span class="c1"># use &quot;qwen2.5-32b-instruct&quot; to calculate the quality scores.</span>
<span class="w">      </span><span class="nt">min_score</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
<span class="w">      </span><span class="nt">input_keys</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;prompt_text&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;response_text&quot;</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># set input_keys and field_names to the existing key names in gsm-8k. Here calculating the difficulty scores according to both questions and answers.</span>
<span class="w">      </span><span class="nt">field_names</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;prompt&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;response&quot;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>All config items in the <code class="docutils literal notranslate"><span class="pre">data_processor</span></code> section can be found <a class="reference internal" href="trinity_configs.html"><span class="std std-doc">here</span></a>. A prepared config file for this example of GSM-8K can be found in <a class="reference external" href="https://github.com/modelscope/Trinity-RFT/tree/main/examples/grpo_gsm8k_experience_pipeline/gsm8k.yaml">the config file</a>.</p>
</section>
<section id="id3">
<h3>Exploring &amp; Training<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<p>After preparing the config files of Trinity-RFT, you can start your ray cluster and run the RFT process including the data active iterator part with the following commands:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># start the ray cluster</span>
<span class="c1"># on master node</span>
ray<span class="w"> </span>start<span class="w"> </span>--head
<span class="c1"># on worker nodes</span>
ray<span class="w"> </span>start<span class="w"> </span>--address<span class="o">=</span>&lt;master_address&gt;

<span class="c1"># run RFT</span>
trinity<span class="w"> </span>run<span class="w"> </span>--config<span class="w"> </span>&lt;Trinity-RFT_config_path&gt;
</pre></div>
</div>
<p>If you follow the steps above, Trinity-RFT will send a request to the data processor server and prepare the experience pipeline.
It will watch the explorer output buffer. Once there is a new batch of experience, the data processor will compute stats for the experience and reshape the rewards. Then it writes the reshaped experience to the trainer input buffer for training.</p>
</section>
</section>
<section id="example-human-in-the-loop">
<h2>Example: Human in the Loop<a class="headerlink" href="#example-human-in-the-loop" title="Link to this heading"></a></h2>
<p>Sometimes, you might need to involve human feedbacks for some raw data. In this example, you will learn how to annotate raw data to get a better dataset before training. This example takes an example Q&amp;A dataset and tries to select the chosen and rejected ones for DPO method.</p>
<p>Before getting started, you need to prepare the main environment of Trinity-RFT according to the installation section of the README file, and <a class="reference external" href="https://github.com/modelscope/data-juicer/tree/main/tools/humanops">start a label-studio server</a> from Data-Juicer from source.</p>
<p>In this example, we start the data processor server manually. Thus, you need to install the dependencies in the <code class="docutils literal notranslate"><span class="pre">data</span></code> split.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;.[data]&quot;</span>
</pre></div>
</div>
<section id="id4">
<h3>Configure the Data Processor<a class="headerlink" href="#id4" title="Link to this heading"></a></h3>
<p>Trinity-RFT uses a unified config file to manage all config items. For the data processor, you need to focus on the <code class="docutils literal notranslate"><span class="pre">data_processor</span></code> section in the config file.</p>
<p>In this example, assume that you need to select the chosen and rejected responses for DPO method. So you can set these config items like the following example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">data_processor</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># task pipeline related</span>
<span class="w">  </span><span class="nt">task_pipeline</span><span class="p">:</span>
<span class="w">    </span><span class="nt">num_process</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">    </span><span class="nt">operators</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;human_preference_annotation_mapper&quot;</span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span>
<span class="w">          </span><span class="c1"># general annotation project settings</span>
<span class="w">          </span><span class="nt">project_name_prefix</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Human_Preference_Annotation_Demo&quot;</span>
<span class="w">          </span><span class="nt">wait_for_annotations</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># Whether to wait for annotations to complete</span>
<span class="w">          </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3600</span><span class="w">  </span><span class="c1"># Maximum time to wait for annotations in seconds (1 hour)</span>
<span class="w">          </span><span class="nt">poll_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w">  </span><span class="c1"># Time between annotation status checks in seconds</span>
<span class="w">          </span><span class="nt">max_tasks_per_batch</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w">  </span><span class="c1"># Maximum number of tasks in a single batch</span>
<span class="w">          </span><span class="nt">notification_config</span><span class="p">:</span>
<span class="w">            </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="w">          </span><span class="c1"># label studio connection settings</span>
<span class="w">          </span><span class="nt">api_url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://localhost:7070&quot;</span><span class="w">  </span><span class="c1"># Default Label Studio URL</span>
<span class="w">          </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;YOUR_API_KEY&quot;</span><span class="w">  </span><span class="c1"># Your API key for label studuio authentication, which can be set when starting the label-studio service</span>

<span class="w">          </span><span class="c1"># human preference annotation settings</span>
<span class="w">          </span><span class="nt">prompt_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;prompt&quot;</span><span class="w">  </span><span class="c1"># Prompt field</span>
<span class="w">          </span><span class="nt">answer1_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;answer1&quot;</span><span class="w">  </span><span class="c1"># First answer option</span>
<span class="w">          </span><span class="nt">answer2_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;answer2&quot;</span><span class="w">  </span><span class="c1"># Second answer option</span>
<span class="w">          </span><span class="nt">chosen_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;chosen&quot;</span><span class="w">  </span><span class="c1"># Chosen field</span>
<span class="w">          </span><span class="nt">rejected_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;rejected&quot;</span><span class="w">  </span><span class="c1"># Rejected field</span>
<span class="w">    </span><span class="nt">inputs</span><span class="p">:</span><span class="w">  </span><span class="c1"># the output will be set to the explorer input automatically</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/PATH/TO/DATA/FILE/TO/BE/ANNOTATED</span>
<span class="w">    </span><span class="nt">target_fields</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;prompt&quot;</span><span class="p p-Indicator">]</span>
<span class="nt">service</span><span class="p">:</span>
<span class="w">  </span><span class="nt">data_juicer</span><span class="p">:</span>
<span class="w">    </span><span class="nt">auto_start</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>Here you can set the basic information for the example dataset and some other items about the input dataset, which is similar to the example above.</p>
<p>The difference is that we use the data-juicer OP <code class="docutils literal notranslate"><span class="pre">human_preference_annotation_mapper</span></code> here. This OP helps you to annotate the data with human preference on a UI.</p>
<p>You can set more config items for this OP (e.g. notification when annotation is finished). For more details, please refer to this <a class="reference external" href="https://github.com/modelscope/data-juicer/tree/main/configs/annotation">doc</a>.</p>
</section>
<section id="start-running">
<h3>Start Running<a class="headerlink" href="#start-running" title="Link to this heading"></a></h3>
<p>When you start running with the RFT config, the data processor will start the OP <code class="docutils literal notranslate"><span class="pre">human_preference_annotation_mapper</span></code>, and then you can find a new project on the “Projects” page of the label-studio server.</p>
<p><img alt="" src="../_images/data-projects.png" /></p>
<p>You can click and enter into this project, and all the samples that need to be annotated are listed on the page.</p>
<p><img alt="" src="../_images/data-in-projects.png" /></p>
<p>Then you can click any sample and you will enter the labelling page.</p>
<p><img alt="" src="../_images/data-in-labelling-page.png" /></p>
<p>For the preference annotation case, you can choose the preferred/right/chosen one and then click the “Submit” button to submit the annotation result. Then you can select other samples and continue this process.</p>
<p><img alt="" src="../_images/data-labelling.png" /></p>
<p>After all samples are annotated, the OP will end automatically and store the result dataset in the target database specified by the config file. When training begins, it will load the prepared dataset and continue the downstream steps.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="example_dpo.html" class="btn btn-neutral float-left" title="Offline DPO and SFT" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="trinity_programming_guide.html" class="btn btn-neutral float-right" title="Developer Guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Trinity-RFT Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    <b>main</b>
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Branches</dt>
      <dd><b><a href="example_data_functionalities.html">main</a> (latest)</b></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>