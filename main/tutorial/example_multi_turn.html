

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Concatenated Multi-Turn RFT &mdash; Trinity-RFT 0.2.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=37f418d5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="General Multi-Step RFT" href="example_step_wise.html" />
    <link rel="prev" title="Asynchronous RFT" href="example_async_mode.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Trinity-RFT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="example_reasoning_basic.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_reasoning_advanced.html">Off-Policy RFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_megatron.html">Megatron-LM Backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_async_mode.html">Asynchronous RFT</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Concatenated Multi-Turn RFT</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#step-1-environments-data-preparation">Step 1: Environments &amp; Data preparation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#environment-preparation">Environment Preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-preparation">Data Preparation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#step-2-config-preparation-and-run-the-experiment">Step 2: Config preparation and run the experiment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#advance-how-to-build-your-own-environment">Advance: How to build your own environment</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="example_step_wise.html">General Multi-Step RFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_react.html">Multi-Step ReAct</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_search_email.html">Email Search Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_dpo.html">Offline DPO and SFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_data_functionalities.html">Data Processing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guidelines</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="trinity_programming_guide.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="trinity_configs.html">Configuration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_mix_algo.html">Algorithm Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="synchronizer.html">Synchronizer in Trinity-RFT</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_reference.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Trinity-RFT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Concatenated Multi-Turn RFT</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/modelscope/Trinity-RFT/blob/main/docs/sphinx_doc/source/tutorial/example_multi_turn.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="concatenated-multi-turn-rft">
<h1>Concatenated Multi-Turn RFT<a class="headerlink" href="#concatenated-multi-turn-rft" title="Link to this heading"></a></h1>
<p>In Trinity-RFT, we support Agentic RL with multiple rounds of interaction with environments.</p>
<p>Trinity’s decoupled design allows you to easily define custom interaction methods between environments and agents through Workflow configuration, to collect corresponding <code class="docutils literal notranslate"><span class="pre">experiences</span></code> for RL training.</p>
<p>Below, we will first provide two multi-round environment Workflows - ALFworld and WebShop - as examples of multi-round interaction.</p>
<p>Here is how to run these two examples step by step.</p>
<section id="step-1-environments-data-preparation">
<h2>Step 1: Environments &amp; Data preparation<a class="headerlink" href="#step-1-environments-data-preparation" title="Link to this heading"></a></h2>
<section id="environment-preparation">
<h3>Environment Preparation<a class="headerlink" href="#environment-preparation" title="Link to this heading"></a></h3>
<p>To run the ALFworld and WebShop env, you need to setup the corresponding environments.</p>
<ul class="simple">
<li><p>ALFworld is a text-based interactive environment that simulates household scenarios. Agents need to understand natural language instructions and complete various domestic tasks like finding objects, moving items, and operating devices in a virtual home environment.</p></li>
<li><p>WebShop is a simulated online shopping environment where AI agents learn to shop based on user requirements. The platform allows agents to browse products, compare options, and make purchase decisions, mimicking real-world e-commerce interactions.</p></li>
</ul>
<br>
<details>
<summary>Guidelines for preparing ALFWorld environment</summary>
<ol class="arabic simple">
<li><p>Pip install: <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">alfworld[full]</span></code></p></li>
<li><p>Export the path: <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">ALFWORLD_DATA=/path/to/alfworld/data</span></code></p></li>
<li><p>Download the environment: <code class="docutils literal notranslate"><span class="pre">alfworld-download</span></code></p></li>
</ol>
<p>Now you can find the environment in <code class="docutils literal notranslate"><span class="pre">$ALFWORLD_DATA</span></code> and continue with the following steps.</p>
</details>
<details>
<summary>Guidelines for preparing WebShop environment</summary>
<ol class="arabic simple">
<li><p>Install Python 3.8.13</p></li>
<li><p>Install Java</p></li>
<li><p>Download the source code: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">https://github.com/princeton-nlp/webshop.git</span> <span class="pre">webshop</span></code></p></li>
<li><p>Create a virtual environment: <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">create</span> <span class="pre">-n</span> <span class="pre">webshop</span> <span class="pre">python=3.8.13</span></code> and <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">activate</span> <span class="pre">webshop</span></code></p></li>
<li><p>Install requirements into the <code class="docutils literal notranslate"><span class="pre">webshop</span></code> virtual environment via the <code class="docutils literal notranslate"><span class="pre">setup.sh</span></code> script: <code class="docutils literal notranslate"><span class="pre">./setup.sh</span> <span class="pre">[-d</span> <span class="pre">small|all]</span></code></p></li>
</ol>
<p>Now you can continue with the following steps.</p>
</details>
<br>
<p>You may refer to their original environment for more details.</p>
<ul class="simple">
<li><p>For ALFWorld, refer to the <a class="reference external" href="https://github.com/alfworld/alfworld">ALFWorld</a> repository.</p></li>
<li><p>For WebShop, refer to the <a class="reference external" href="https://github.com/princeton-nlp/WebShop">WebShop</a> repository.</p></li>
</ul>
</section>
<section id="data-preparation">
<h3>Data Preparation<a class="headerlink" href="#data-preparation" title="Link to this heading"></a></h3>
<p>Our dataset follows the format in Huggingface datasets library, so we should correspondingly convert our env dataset.</p>
<p>Just check the data preparation scripts and run the following command.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># For ALFworld env</span>
python<span class="w"> </span>examples/grpo_alfworld/get_alfworld_data.py

<span class="c1"># For WebShop env</span>
python<span class="w"> </span>examples/grpo_webshop/get_webshop_data.py
</pre></div>
</div>
<p>The task is described as an environment instead of a single prompt.</p>
<ul class="simple">
<li><p>For ALFworld env, the task description is the <code class="docutils literal notranslate"><span class="pre">game_file</span></code> file path.</p></li>
<li><p>For Webshop env, the task description is the env’s <code class="docutils literal notranslate"><span class="pre">task_id</span></code>, which is passed to the env as session_id to reset on.</p></li>
</ul>
</section>
</section>
<section id="step-2-config-preparation-and-run-the-experiment">
<h2>Step 2: Config preparation and run the experiment<a class="headerlink" href="#step-2-config-preparation-and-run-the-experiment" title="Link to this heading"></a></h2>
<p>You can refer to <a class="reference internal" href="example_reasoning_basic.html"><span class="std std-doc">Quick Start</span></a> to setup the config and others. The default config files are <a class="reference external" href="https://github.com/modelscope/Trinity-RFT/tree/main/examples/grpo_alfworld/alfworld.yaml"><code class="docutils literal notranslate"><span class="pre">alfworld.yaml</span></code></a> and <a class="reference external" href="https://github.com/modelscope/Trinity-RFT/tree/main/examples/grpo_webshop/webshop.yaml"><code class="docutils literal notranslate"><span class="pre">webshop.yaml</span></code></a>, respectively.
You may revise the configurations properly and run the experiment!</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># For ALFworld env</span>
trinity<span class="w"> </span>run<span class="w"> </span>--config<span class="w"> </span>examples/grpo_alfworld/alfworld.yaml

<span class="c1"># For WebShop env</span>
trinity<span class="w"> </span>run<span class="w"> </span>--config<span class="w"> </span>examples/grpo_webshop/webshop.yaml
</pre></div>
</div>
</section>
<section id="advance-how-to-build-your-own-environment">
<h2>Advance: How to build your own environment<a class="headerlink" href="#advance-how-to-build-your-own-environment" title="Link to this heading"></a></h2>
<p>We provide an easy way to allow you build your own environment pipeline by creating a new workflow.</p>
<p>See the <code class="docutils literal notranslate"><span class="pre">trinity/common/workflows/envs/alfworld/alfworld_workflow.py</span></code> as an example on how to construct a multi-round workflow.</p>
<p>You can interact with environment using the messages format, and call the <code class="docutils literal notranslate"><span class="pre">self.process_messages_to_experience</span></code> function to transform the messages and rewards into the <code class="docutils literal notranslate"><span class="pre">experience</span></code> we need, and send them to buffer.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AlfworldWorkflow</span><span class="p">(</span><span class="n">MultiTurnWorkflow</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A workflow for alfworld task.&quot;&quot;&quot;</span>
    <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_env_inference_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">rollout_num</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Experience</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating env inference samples...&quot;</span><span class="p">)</span>
        <span class="n">experience_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rollout_num</span><span class="p">):</span>
            <span class="n">observation</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">final_reward</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
            <span class="n">memory</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">memory</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">AlfWORLD_SYSTEM_PROMPT</span><span class="p">})</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_env_steps</span><span class="p">):</span>
                <span class="n">format_obs</span> <span class="o">=</span> <span class="n">format_observation</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
                <span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span> <span class="o">+</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">format_obs</span><span class="p">}]</span>
                <span class="n">response_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_response_text</span><span class="p">(</span><span class="n">memory</span><span class="p">)</span>
                <span class="n">memory</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">response_text</span><span class="p">})</span>
                <span class="n">action</span> <span class="o">=</span> <span class="n">parse_action</span><span class="p">(</span><span class="n">response_text</span><span class="p">)</span>
                <span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                    <span class="n">final_reward</span> <span class="o">=</span> <span class="n">reward</span>
                    <span class="k">break</span>
            <span class="n">experience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_messages_to_experience</span><span class="p">(</span>
                <span class="n">memory</span><span class="p">,</span> <span class="n">final_reward</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;env_rounds&quot;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s2">&quot;env_done&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">done</span> <span class="k">else</span> <span class="mi">0</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">experience_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">experience</span><span class="p">)</span>
        <span class="c1"># Close the env to save cpu memory</span>
        <span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">experience_list</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Experience</span><span class="p">]:</span>
        <span class="o">...</span>
        <span class="n">game_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_desc</span>
        <span class="n">rollout_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat_times</span>
        <span class="o">...</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">create_environment</span><span class="p">(</span><span class="n">game_file_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_env_inference_samples</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">rollout_n</span><span class="p">)</span>
</pre></div>
</div>
<p>Also, remember to register your workflow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@WORKFLOWS</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="s2">&quot;alfworld_workflow&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AlfworldWorkflow</span><span class="p">(</span><span class="n">MultiTurnWorkflow</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A workflow for alfworld task.&quot;&quot;&quot;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>and include it in the init file <code class="docutils literal notranslate"><span class="pre">trinity/common/workflows/__init__.py</span></code></p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w"> </span># -*- coding: utf-8 -*-
<span class="w"> </span>&quot;&quot;&quot;Workflow module&quot;&quot;&quot;
<span class="w"> </span>from .workflow import WORKFLOWS, MathWorkflow, SimpleWorkflow
<span class="gi">+from .envs.alfworld.alfworld_workflow import AlfworldWorkflow</span>

<span class="w"> </span>__all__ = [
<span class="w"> </span>    &quot;WORKFLOWS&quot;,
<span class="w"> </span>    &quot;SimpleWorkflow&quot;,
<span class="w"> </span>    &quot;MathWorkflow&quot;,
<span class="gi">+    &quot;AlfworldWorkflow&quot;,</span>
<span class="w"> </span>]
</pre></div>
</div>
<p>Then you are all set! It should be pretty simple😄, and the training processes in both environments converge.</p>
<p><img alt="" src="../_images/alfworld_reward_curve.png" />
<img alt="" src="../_images/webshop_reward_curve.png" /></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="example_async_mode.html" class="btn btn-neutral float-left" title="Asynchronous RFT" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="example_step_wise.html" class="btn btn-neutral float-right" title="General Multi-Step RFT" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Trinity-RFT Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    <b>main</b>
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Branches</dt>
      <dd><b><a href="example_multi_turn.html">main</a> (latest)</b></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>