

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Developer Guide &mdash; Trinity-RFT 0.2.1.dev0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=8c48c73b"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Configuration Guide" href="trinity_configs.html" />
    <link rel="prev" title="Data Processing" href="example_data_functionalities.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Trinity-RFT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="example_reasoning_basic.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_reasoning_advanced.html">Off-Policy RFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_async_mode.html">Asynchronous RFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_multi_turn.html">Concatenated Multi-Turn RFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_step_wise.html">General Multi-Step RFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_react.html">Multi-Step ReAct</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_dpo.html">Offline DPO and SFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_data_functionalities.html">Data Processing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guidelines</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developer Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#workflows-for-rl-environment-developers">Workflows (For RL Environment Developers)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-0-basic-concepts">Step 0: Basic Concepts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-1-prepare-task-dataset">Step 1: Prepare Task Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-2-implement-a-new-workflow">Step 2: Implement a New Workflow</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-3-use-your-workflow">Step 3: Use Your Workflow</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#algorithms-for-rl-algorithm-developers">Algorithms (For RL Algorithm Developers)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-0-basic-concepts-of-algorithm-module">Step 0: Basic Concepts of Algorithm Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-1-implement-algorithm-components">Step 1: Implement Algorithm Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-2-register-your-algorithm">Step 2: Register Your Algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-3-use-your-algorithm">Step 3: Use Your Algorithm</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#adding-new-config-entries-for-the-config-generator-advanced">Adding New Config Entries for the Config Generator (Advanced)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-0-understanding-streamlit">Step 0: Understanding Streamlit</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-1-implement-new-config-entries">Step 1: Implement New Config Entries</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-2-integrating-new-parameters-into-config-manager-py">Step 2: Integrating New Parameters into <code class="docutils literal notranslate"><span class="pre">config_manager.py</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#check-code-style">Check Code Style</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="trinity_configs.html">Configuration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_mix_algo.html">Algorithm Development</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_reference.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Trinity-RFT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Developer Guide</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/modelscope/Trinity-RFT/blob/main/docs/sphinx_doc/source/tutorial/trinity_programming_guide.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="developer-guide">
<h1>Developer Guide<a class="headerlink" href="#developer-guide" title="Link to this heading"></a></h1>
<p>This guide introduces how to develop new modules in Trinity-RFT and provides relevant development guidelines.</p>
<p>In Trinity-RFT, we decompose the RL pipeline into three main modules (<strong>Explorer</strong>, <strong>Trainer</strong> and <strong>Buffer</strong>) to facilitate customization and extension.
Below is a table summarizing the modules and components that developers with different targets need to focus on.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Development Target</p></th>
<th class="head"><p>Core Module</p></th>
<th class="head"><p>Key Component</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Apply existing RL algorithms to new environments.</p></td>
<td><p><em>Explorer</em></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Workflow</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Design new RL algorithms.</p></td>
<td><p><em>Trainer</em></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Algorithm</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Enhance the RL process from the data perspective.</p></td>
<td><p><em>Buffer</em></p></td>
<td><p>Data Processing Module (Coming soon)</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Trinity-RFT is still under development, and the following interfaces may change. Please read this section in conjunction with the latest code.</p>
</div>
<hr class="docutils" />
<section id="workflows-for-rl-environment-developers">
<span id="workflows"></span><h2>Workflows (For RL Environment Developers)<a class="headerlink" href="#workflows-for-rl-environment-developers" title="Link to this heading"></a></h2>
<p>In Trinity-RFT, workflows are the core components that define the interaction between Agents and Environments.
A qualified workflow needs to use the trained model to complete the specified task and obtain feedback information (reward) from the environment. Below are the steps to create a new workflow:</p>
<hr class="docutils" />
<section id="step-0-basic-concepts">
<h3>Step 0: Basic Concepts<a class="headerlink" href="#step-0-basic-concepts" title="Link to this heading"></a></h3>
<p>Before starting development, it’s important to understand several core concepts:</p>
<ul class="simple">
<li><p><strong>Task</strong> (<a class="reference internal" href="../build_api/trinity.common.workflows.html#trinity.common.workflows.Task" title="trinity.common.workflows.Task"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.common.workflows.Task</span></code></a>): Represents a data structure that can be converted into a <code class="docutils literal notranslate"><span class="pre">Workflow</span></code>. The content of the <code class="docutils literal notranslate"><span class="pre">Task</span></code> varies depending on the task type:</p>
<ul>
<li><p><strong>Math problems</strong>: A <code class="docutils literal notranslate"><span class="pre">Task</span></code> contains the problem description and the golden answer.</p></li>
<li><p><strong>Programming scenarios</strong>: A <code class="docutils literal notranslate"><span class="pre">Task</span></code> includes the problem description, test cases, runtime environment, and other complex information.</p></li>
</ul>
</li>
<li><p><strong>Workflow</strong> (<a class="reference internal" href="../build_api/trinity.common.workflows.html#trinity.common.workflows.Workflow" title="trinity.common.workflows.Workflow"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.common.workflows.Workflow</span></code></a>): Describes how a <code class="docutils literal notranslate"><span class="pre">Task</span></code> is executed. It defines the interaction flow between Agents and Environments, including logic similar to <em>Rollout</em> and <em>Reward</em> calculations in other frameworks. After execution, it generates a list of <code class="docutils literal notranslate"><span class="pre">Experience</span></code>. Trinity-RFT includes several built-in workflows:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">MathWorkflow</span></code> (<a class="reference internal" href="../build_api/trinity.common.workflows.html#trinity.common.workflows.MathWorkflow" title="trinity.common.workflows.MathWorkflow"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.common.workflows.MathWorkflow</span></code></a>): For math scenarios, submits problems to LLM, parses LLM responses, and calculates scores (rewards).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">WebShopWorkflow</span></code> (<a class="reference internal" href="../build_api/trinity.common.workflows.html#trinity.common.workflows.WebShopWorkflow" title="trinity.common.workflows.WebShopWorkflow"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.common.workflows.WebShopWorkflow</span></code></a>): For webshop scenarios, it contains multi-turn interaction with environment.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CodeWorkflow</span></code> (Coming soon): For coding scenarios, executes returned code, runs tests, and calculates rewards based on test results.</p></li>
<li><p>…</p></li>
</ul>
</li>
<li><p><strong>Experience</strong> (<a class="reference internal" href="../build_api/trinity.common.html#trinity.common.experience.Experience" title="trinity.common.experience.Experience"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.common.experience.Experience</span></code></a>): The output of running a <code class="docutils literal notranslate"><span class="pre">Workflow</span></code>.  The internal data format depends on the training algorithm used. For example, for common PPO/GRPO algorithms, <code class="docutils literal notranslate"><span class="pre">Experience</span></code> includes lists of token IDs, action masks (identifying which tokens were generated by the LLM), log probabilities, rewards, etc.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="step-1-prepare-task-dataset">
<h3>Step 1: Prepare Task Dataset<a class="headerlink" href="#step-1-prepare-task-dataset" title="Link to this heading"></a></h3>
<p>The task dataset is loaded via the <code class="docutils literal notranslate"><span class="pre">buffer.explorer_input.taskset</span></code> configuration entry in your YAML config file.
To handle differences in <code class="docutils literal notranslate"><span class="pre">Task</span></code> contents, Trinity-RFT provides a unified <code class="docutils literal notranslate"><span class="pre">Task</span></code> interface containing the following fields.</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">workflow</span></code></strong> (<code class="docutils literal notranslate"><span class="pre">str</span></code>): The registered name of your workflow class. You can specify it in <code class="docutils literal notranslate"><span class="pre">buffer.explorer_input.taskset.default_workflow_type</span></code> of your YAML config file.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">reward_fn</span></code></strong> (<code class="docutils literal notranslate"><span class="pre">Optional[str]</span></code>): The registered name of your reward function. You can specify it in <code class="docutils literal notranslate"><span class="pre">buffer.explorer_input.taskset.default_reward_fn_type</span></code>. Note that some workflows already include built-in reward calculation; in such cases, you can omit this field.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">raw_task</span></code></strong> (<code class="docutils literal notranslate"><span class="pre">Dict</span></code>): A record of raw data in <code class="docutils literal notranslate"><span class="pre">Dict</span></code> format. For highly customized workflow, you can directly use <code class="docutils literal notranslate"><span class="pre">raw_task</span></code> to initialize your <code class="docutils literal notranslate"><span class="pre">Workflow</span></code> instance without relying on the following fields.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">format_args</span></code></strong> (<a class="reference internal" href="../build_api/trinity.common.html#trinity.common.config.FormatConfig" title="trinity.common.config.FormatConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.common.config.FormatConfig</span></code></a>): Parameters to facilitate the construction of <code class="docutils literal notranslate"><span class="pre">Workflow</span></code> instances. For example, the <code class="docutils literal notranslate"><span class="pre">prompt_key</span></code> and <code class="docutils literal notranslate"><span class="pre">response_key</span></code> can be used to get the prompt and response from <code class="docutils literal notranslate"><span class="pre">raw_task</span></code>. These settings come from the YAML configuration file and can be set in <code class="docutils literal notranslate"><span class="pre">buffer.explorer_input.task_set.format</span></code>.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">rollout_args</span></code></strong> (<a class="reference internal" href="../build_api/trinity.common.html#trinity.common.config.GenerationConfig" title="trinity.common.config.GenerationConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.common.config.GenerationConfig</span></code></a>): Parameters that control the rollout process, such as <code class="docutils literal notranslate"><span class="pre">temperature</span></code>. This field also comes from the YAML configuration file and can be set in <code class="docutils literal notranslate"><span class="pre">buffer.explorer_input.task_set.rollout_args</span></code>.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">workflow_args</span></code></strong> (<code class="docutils literal notranslate"><span class="pre">Dict</span></code>): A dictionary of parameters to facilitate the construction of <code class="docutils literal notranslate"><span class="pre">Workflow</span></code> instances. Provides more flexibility than <code class="docutils literal notranslate"><span class="pre">format_args</span></code> and <code class="docutils literal notranslate"><span class="pre">rollout_args</span></code> by using a dictionary. This field also comes from the YAML configuration file and can be set in <code class="docutils literal notranslate"><span class="pre">buffer.explorer_input.task_set.workflow_args</span></code>. Normally, you do not need to set this field.</p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code class="docutils literal notranslate"><span class="pre">workflow</span></code>, <code class="docutils literal notranslate"><span class="pre">workflow_args</span></code> and <code class="docutils literal notranslate"><span class="pre">raw_task</span></code> provide different levels of customization.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">workflow</span></code> provides the global settings for all tasks that uses the same workflow. (Global Level)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">workflow_args</span></code> can be set for each task dataset, allowing different task datasets using the same workflow to behave differently. (Dataset Level)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">raw_task</span></code> provides the ability to customize the behavior of each task, which is most flexible. (Data Sample Level)</p></li>
</ul>
</div>
<p>In the math problem scenario, the <code class="docutils literal notranslate"><span class="pre">Task</span></code> dataset can be a <code class="docutils literal notranslate"><span class="pre">jsonl</span></code> file, where each line contains JSON with <code class="docutils literal notranslate"><span class="pre">question</span></code> and <code class="docutils literal notranslate"><span class="pre">answer</span></code> fields representing the problem description and standard answer, respectively. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="s2">&quot;1+1=&quot;</span><span class="p">,</span> <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="s2">&quot;2+2=&quot;</span><span class="p">,</span> <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">}</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Example configuration snippet:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># some config</span>
<span class="nt">buffer</span><span class="p">:</span>
<span class="w">  </span><span class="nt">explorer_input</span><span class="p">:</span>
<span class="w">    </span><span class="nt">taskset</span><span class="p">:</span>
<span class="w">      </span><span class="nt">default_workflow</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;math_workflow&quot;</span>
<span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/PATH/TO/FILE/DIR&quot;</span>
<span class="w">      </span><span class="nt">format</span><span class="p">:</span>
<span class="w">        </span><span class="nt">prompt_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;question&quot;</span>
<span class="w">        </span><span class="nt">response_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;answer&quot;</span>
<span class="w">      </span><span class="nt">rollout_args</span><span class="p">:</span>
<span class="w">        </span><span class="nt">temperature</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
<span class="w">      </span><span class="c1"># some other configs</span>
</pre></div>
</div>
<p>In this example, each task object’s <code class="docutils literal notranslate"><span class="pre">raw_task</span></code> is a <code class="docutils literal notranslate"><span class="pre">Dict</span></code> with two keys (<code class="docutils literal notranslate"><span class="pre">question</span></code> and <code class="docutils literal notranslate"><span class="pre">answer</span></code>). The <code class="docutils literal notranslate"><span class="pre">MathWorkflow</span></code> uses the <code class="docutils literal notranslate"><span class="pre">prompt_key</span></code> and <code class="docutils literal notranslate"><span class="pre">response_key</span></code> to extract the question and answer from the <code class="docutils literal notranslate"><span class="pre">raw_task</span></code> and use the <code class="docutils literal notranslate"><span class="pre">rollout_args</span></code> to generate the response.</p>
</section>
<hr class="docutils" />
<section id="step-2-implement-a-new-workflow">
<h3>Step 2: Implement a New Workflow<a class="headerlink" href="#step-2-implement-a-new-workflow" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Workflow</span></code> base class interface is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Workflow</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">ModelWrapper</span><span class="p">,</span>
        <span class="n">auxiliary_models</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">openai</span><span class="o">.</span><span class="n">OpenAI</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_models</span> <span class="o">=</span> <span class="n">auxiliary_models</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Experience</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the workflow and return a list of Experiences.&quot;&quot;&quot;</span>
</pre></div>
</div>
<section id="initialize-your-workflow">
<h4>Initialize Your Workflow<a class="headerlink" href="#initialize-your-workflow" title="Link to this heading"></a></h4>
<p>During initialization, <code class="docutils literal notranslate"><span class="pre">Workflow</span></code> receives the following parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">task</span></code>(<a class="reference internal" href="../build_api/trinity.common.workflows.html#trinity.common.workflows.Task" title="trinity.common.workflows.Task"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.common.workflows.Task</span></code></a>): A single data item from the task dataset.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">model</span></code>(<a class="reference internal" href="../build_api/trinity.common.models.html#trinity.common.models.model.ModelWrapper" title="trinity.common.models.model.ModelWrapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.common.models.model.ModelWrapper</span></code></a>): The model being trained, which provides an interface similar to OpenAI, capable of receiving a list of conversation messages and returning content generated by the LLM (including reply text <code class="docutils literal notranslate"><span class="pre">response_text</span></code>, full sequence token ids <code class="docutils literal notranslate"><span class="pre">tokens</span></code>, prompt part token length <code class="docutils literal notranslate"><span class="pre">prompt_length</span></code>, and a list of output token logprobs <code class="docutils literal notranslate"><span class="pre">logprobs</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">auxiliary_models</span></code>(<code class="docutils literal notranslate"><span class="pre">List[openai.OpenAI]</span></code>):A list of auxiliary models not involved in training. All are provided via OpenAI-compatible APIs.</p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can switch to using the OpenAI API by setting <code class="docutils literal notranslate"><span class="pre">explorer.rollout_model.enable_openai_api</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code> in your config file and calling <code class="docutils literal notranslate"><span class="pre">model.get_openai_client()</span></code> to get an <code class="docutils literal notranslate"><span class="pre">openai.OpenAI</span></code> instance in your workflow.
And the <code class="docutils literal notranslate"><span class="pre">model</span></code> field when calling openai API can be obtained via <code class="docutils literal notranslate"><span class="pre">openai_client.models.list().data[0].id</span></code> or <code class="docutils literal notranslate"><span class="pre">openai_client.model_path</span></code>.</p>
</div>
<p>Here’s an example of initializing a simple workflow using only <code class="docutils literal notranslate"><span class="pre">raw_task</span></code> and <code class="docutils literal notranslate"><span class="pre">rollout_args</span></code>. In more complex cases, you can use the <code class="docutils literal notranslate"><span class="pre">format_args</span></code> for further customization.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ExampleWorkflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelWrapper</span><span class="p">,</span> <span class="n">auxiliary_models</span><span class="p">:</span> <span class="n">List</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">auxiliary_models</span><span class="o">=</span><span class="n">auxiliary_models</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">question</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">raw_task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;question&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">answer</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">raw_task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;answer&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rollout_args</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">rollout_args</span>
        <span class="c1"># Optional: If you want to use OpenAI API in your workflow</span>
        <span class="c1"># self.openai_client = self.model.get_openai_client()</span>
</pre></div>
</div>
</section>
<section id="implementing-the-run-method">
<h4>Implementing the <code class="docutils literal notranslate"><span class="pre">run</span></code> method<a class="headerlink" href="#implementing-the-run-method" title="Link to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">run</span></code> method is the core of your workflow. It returns a list of <code class="docutils literal notranslate"><span class="pre">Experience</span></code>.
Below is a simple implementation for a math workflow.</p>
<p>We first call the model to generate multiple response using the provided question and rollout arguments.
Then we calculate the reward for each response using the <code class="docutils literal notranslate"><span class="pre">calculate_reward</span></code> function.
Finally, we construct a list of <code class="docutils literal notranslate"><span class="pre">Experience</span></code> with the responses and rewards and return it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ExampleWorkflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>

    <span class="c1"># the __init__ function</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">truth</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="n">truth</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Experience</span><span class="p">]:</span>
        <span class="c1"># call the model to generate multiple responses</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Question:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rollout_args</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rollout_args</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">experiences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
            <span class="c1"># calulcate reward</span>
            <span class="n">reward</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_reward</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">response_text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer</span><span class="p">)</span>
            <span class="c1"># construct Experience</span>
            <span class="n">experiences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Experience</span><span class="p">(</span>
                    <span class="n">tokens</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">tokens</span><span class="p">,</span>
                    <span class="n">prompt_length</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">prompt_length</span><span class="p">,</span>
                    <span class="n">reward</span><span class="o">=</span><span class="n">reward</span><span class="p">,</span>
                    <span class="n">logprobs</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">logprobs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">experiences</span>
</pre></div>
</div>
</section>
<section id="registering-your-workflow">
<h4>Registering Your Workflow<a class="headerlink" href="#registering-your-workflow" title="Link to this heading"></a></h4>
<p>Register your workflow using the <code class="docutils literal notranslate"><span class="pre">WORKFLOWS.register_module</span></code> decorator.
Ensure the name does not conflict with existing workflows.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># import some packages</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">trinity.common.workflows.workflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">WORKFLOWS</span>

<span class="nd">@WORKFLOWS</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="s2">&quot;example_workflow&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ExampleWorkflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>For workflows that are prepared to be contributed to Trinity-RFT project, you need to place the above code in <code class="docutils literal notranslate"><span class="pre">trinity/common/workflows</span></code> folder, e.g., <code class="docutils literal notranslate"><span class="pre">trinity/common/workflows/example_workflow.py</span></code>. And add the following line to <code class="docutils literal notranslate"><span class="pre">trinity/common/workflows/__init__.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># existing import lines</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.example_workflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExampleWorkflow</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># existing __all__ lines</span>
    <span class="s2">&quot;ExampleWorkflow&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
<p>For workflows that are not intended to be contributed to Trinity-RFT project, you can just place the above code in <code class="docutils literal notranslate"><span class="pre">trinity/plugins</span></code>. Trinity-RFT will automatically detect and load all custom modules in this folder.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can specify the directory where your custom modules are located by setting <code class="docutils literal notranslate"><span class="pre">--plugin-dir</span></code> when starting Trinity-RFT. If you don’t specify <code class="docutils literal notranslate"><span class="pre">--plugin-dir</span></code>, Trinity-RFT will use <code class="docutils literal notranslate"><span class="pre">&lt;Trinity_RFT_ROOT_DIR&gt;/trinity/plugins</span></code> as the default directory.</p>
</div>
</section>
<section id="avoid-re-initialization">
<h4>Avoid Re-initialization<a class="headerlink" href="#avoid-re-initialization" title="Link to this heading"></a></h4>
<p>For heavy workflows, re-initializing every time can incurs extra computational costs.
In this case, you can implement the <code class="docutils literal notranslate"><span class="pre">resettable</span></code> and <code class="docutils literal notranslate"><span class="pre">reset</span></code> methods to avoid re-initialization.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@WORKFLOWS</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="s2">&quot;example_workflow&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ExampleWorkflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>
    <span class="c1"># some code</span>
    <span class="c1"># ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">resettable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">question</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">raw_task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;question&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">answer</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">raw_task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;answer&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="full-code-example">
<h4>Full Code Example<a class="headerlink" href="#full-code-example" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@WORKFLOWS</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="s2">&quot;example_workflow&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ExampleWorkflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelWrapper</span><span class="p">,</span> <span class="n">auxiliary_models</span><span class="p">:</span> <span class="n">List</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">auxiliary_models</span><span class="o">=</span><span class="n">auxiliary_models</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">question</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">raw_task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;question&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">answer</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">raw_task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;answer&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rollout_args</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">rollout_args</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">truth</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="n">truth</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Experience</span><span class="p">]:</span>
        <span class="c1"># call the model to generate multiple responses</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Question:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rollout_args</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rollout_args</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">experiences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
            <span class="c1"># calulcate reward</span>
            <span class="n">reward</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_reward</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">response_text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer</span><span class="p">)</span>
            <span class="c1"># construct Experience</span>
            <span class="n">experiences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Experience</span><span class="p">(</span>
                    <span class="n">tokens</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">tokens</span><span class="p">,</span>
                    <span class="n">prompt_length</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">prompt_length</span><span class="p">,</span>
                    <span class="n">reward</span><span class="o">=</span><span class="n">reward</span><span class="p">,</span>
                    <span class="n">logprobs</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">logprobs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">experiences</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">resettable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">question</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">raw_task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;question&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">answer</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">raw_task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;answer&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="step-3-use-your-workflow">
<h3>Step 3: Use Your Workflow<a class="headerlink" href="#step-3-use-your-workflow" title="Link to this heading"></a></h3>
<p>After implementing and registering your workflow, you need to update the configuration file to set the <code class="docutils literal notranslate"><span class="pre">default_workflow_type</span></code> in the <code class="docutils literal notranslate"><span class="pre">buffer.explorer_input.taskset</span></code> domain to the newly registered <code class="docutils literal notranslate"><span class="pre">Workflow</span></code> name.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">buffer</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># Other fields</span>
<span class="w">  </span><span class="nt">explorer_input</span><span class="p">:</span>
<span class="w">    </span><span class="nt">taskset</span><span class="p">:</span>
<span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/taskset</span>
<span class="w">      </span><span class="nt">default_workflow_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example_workflow</span>
<span class="w">      </span><span class="c1"># Other fields</span>
</pre></div>
</div>
<p>Now you can run your workflow in Trinity-RFT using the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">trinity</span> <span class="n">run</span> <span class="o">--</span><span class="n">config</span> <span class="o">&lt;</span><span class="n">your_yaml_file</span><span class="o">&gt;</span>
</pre></div>
</div>
<hr class="docutils" />
</section>
</section>
<section id="algorithms-for-rl-algorithm-developers">
<span id="algorithms"></span><h2>Algorithms (For RL Algorithm Developers)<a class="headerlink" href="#algorithms-for-rl-algorithm-developers" title="Link to this heading"></a></h2>
<p>Trinity-RFT provides a standardized process for implementing new algorithms.</p>
<section id="step-0-basic-concepts-of-algorithm-module">
<h3>Step 0: Basic Concepts of Algorithm Module<a class="headerlink" href="#step-0-basic-concepts-of-algorithm-module" title="Link to this heading"></a></h3>
<p>In Trinity-RFT, the algorithm module is primarily responsible for extracting experience data from the Replay Buffer during the RL process and calculating the loss to update models based on this data.
To avoid implementing a new Trainer class each time a new algorithm is added, we have decomposed the representative PPO algorithm process into multiple sub-modules to adapt to various algorithms.</p>
<ul class="simple">
<li><p><strong>Add Strategy</strong> (<a class="reference internal" href="../build_api/trinity.algorithm.html#trinity.algorithm.AddStrategy" title="trinity.algorithm.AddStrategy"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.algorithm.AddStrategy</span></code></a>): Responsible for adding rollout experience data to the Replay Buffer. You can do some filtering or grouping of experience data before adding it to the buffer. For example, calculate the GRPO advantage in this module and filter out groups with the same reward.</p></li>
<li><p><strong>Sample Strategy</strong> (<a class="reference internal" href="../build_api/trinity.algorithm.html#trinity.algorithm.SampleStrategy" title="trinity.algorithm.SampleStrategy"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.algorithm.SampleStrategy</span></code></a>): Responsible for sampling experience data from the buffer module. By customizing this module, you can implement functionalities like filtering experience data or mixed sampling from multiple data sources.</p></li>
<li><p><strong>Advantage Fn</strong>(<a class="reference internal" href="../build_api/trinity.algorithm.html#trinity.algorithm.AdvantageFn" title="trinity.algorithm.AdvantageFn"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.algorithm.AdvantageFn</span></code></a>): Responsible for calculating the Advantage and Returns of experience data. Note that you might not be able to get a whole group of experiences in this module (depending on how experiences are written to and sampled from the buffer). Thus, if you need group based Advantage calculation, it is highly recommended that you implement it in the <code class="docutils literal notranslate"><span class="pre">AddStrategy</span></code> module instead. Only per-sample advantage calculation is recommended in this module, e.g., PPO.</p></li>
<li><p><strong>Policy Loss Fn</strong>(<a class="reference internal" href="../build_api/trinity.algorithm.html#trinity.algorithm.PolicyLossFn" title="trinity.algorithm.PolicyLossFn"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.algorithm.PolicyLossFn</span></code></a>): Responsible for calculating the core training loss of the policy network.</p></li>
<li><p><strong>KL Fn</strong>(<a class="reference internal" href="../build_api/trinity.algorithm.html#trinity.algorithm.KLFn" title="trinity.algorithm.KLFn"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.algorithm.KLFn</span></code></a>): Responsible for calculating KL Divergence, which is generally used in two places in existing RL algorithms: Reward Penalty and Actor Loss.</p></li>
<li><p><strong>Entropy Loss Fn</strong>(<a class="reference internal" href="../build_api/trinity.algorithm.html#trinity.algorithm.EntropyLossFn" title="trinity.algorithm.EntropyLossFn"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.algorithm.EntropyLossFn</span></code></a>): Responsible for calculating the entropy loss of the policy network.</p></li>
</ul>
<p>We provide several implementations of above modules in <code class="docutils literal notranslate"><span class="pre">trinity/algorithm</span></code>.</p>
</section>
<hr class="docutils" />
<section id="step-1-implement-algorithm-components">
<h3>Step 1: Implement Algorithm Components<a class="headerlink" href="#step-1-implement-algorithm-components" title="Link to this heading"></a></h3>
<p>Trinity-RFT allows developers to customize all the above modules. Developers only need to implement specific modules according to the requirements of their new algorithm. This section will provide a simple introduction using the <a class="reference internal" href="example_reasoning_advanced.html#opmd"><span class="std std-ref">OPMD</span></a> algorithm as an example.</p>
<p>The main difference between OPMD and PPO algorithms lies in the calculation of Advantage and Policy Loss.
OPMD relies on a group-based advantage calculation and does not use the Critic model.
To implement OPMD, developers need to implement advantage calculation in <code class="docutils literal notranslate"><span class="pre">AddStrategy</span></code> (or <code class="docutils literal notranslate"><span class="pre">AdvantageFn</span></code>) and policy loss calculation in <code class="docutils literal notranslate"><span class="pre">PolicyLossFn</span></code>.</p>
<hr class="docutils" />
<section id="step-1-1-implement-addstrategy">
<h4>Step 1.1: Implement <code class="docutils literal notranslate"><span class="pre">AddStrategy</span></code><a class="headerlink" href="#step-1-1-implement-addstrategy" title="Link to this heading"></a></h4>
<p>The <a class="reference internal" href="../build_api/trinity.algorithm.html#trinity.algorithm.AddStrategy" title="trinity.algorithm.AddStrategy"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.algorithm.AddStrategy</span></code></a> interface includes two methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">add</span></code>: This method is called to add experience data to the buffer. It receives a list of experiences and returns the number of experiences added to the buffer.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default_args</span></code>: This method returns the default initialization parameters in dictionary form, which will be used by default when users don’t specify initialization parameters in the configuration file.</p></li>
</ul>
<p>For convenience, Trinity-RFT provides an abstract class <code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.algorithm.GroupAdvantageStrategy</span></code> that implements the <code class="docutils literal notranslate"><span class="pre">add</span></code> method for group-based advantage calculation, you can focus on how to group the experiences and calculate advantages on grouped experiences with the following two methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">group_experiences</span></code>: This method groups a experiences generated in a step into multiple sub-groups.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">calculate_group_advantage</span></code>: This method calculates the advantage for each group of experiences.</p></li>
</ul>
<p>Here’s an implementation example for the OPMD algorithm’s Add Strategy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">trinity.algorithm.add_strategy</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADD_STRATEGY</span><span class="p">,</span> <span class="n">GroupAdvantageStrategy</span>

<span class="nd">@ADD_STRATEGY</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="s2">&quot;opmd&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OPMDAddStrategy</span><span class="p">(</span><span class="n">GroupAdvantageStrategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An example AddStrategy that calculates OPMD advantages.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="p">:</span> <span class="n">BufferWriter</span><span class="p">,</span> <span class="n">opmd_baseline</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">opmd_baseline</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
            <span class="s2">&quot;logavgexp&quot;</span><span class="p">,</span>
        <span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;opmd_baseline must be &#39;mean&#39; or &#39;logavgexp&#39;, got </span><span class="si">{</span><span class="n">opmd_baseline</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opmd_baseline</span> <span class="o">=</span> <span class="n">opmd_baseline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">group_experiences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exps</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">group_by</span><span class="p">(</span><span class="n">exps</span><span class="p">,</span> <span class="n">id_type</span><span class="o">=</span><span class="s2">&quot;task&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_group_advantage</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">group_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Experience</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Experience</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]:</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">group_baseline</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group_rewards</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">exp</span><span class="o">.</span><span class="n">reward</span> <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">exps</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opmd_baseline</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
                    <span class="n">group_baseline</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">group_rewards</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">group_baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="n">torch</span><span class="o">.</span><span class="n">logsumexp</span><span class="p">(</span><span class="n">group_rewards</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exps</span><span class="p">)))</span>
                    <span class="p">)</span>
            <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">exps</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">reward</span> <span class="o">-</span> <span class="n">group_baseline</span>
                <span class="n">exp</span><span class="o">.</span><span class="n">advantages</span> <span class="o">=</span> <span class="n">score</span> <span class="o">*</span> <span class="n">exp</span><span class="o">.</span><span class="n">action_mask</span>
                <span class="n">exp</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">advantages</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;group_baseline&quot;</span><span class="p">:</span> <span class="n">group_baseline</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">exps</span><span class="p">,</span> <span class="n">metrics</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_args</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;opmd_baseline&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;tau&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
</pre></div>
</div>
<p>After implementation, you need to register this module through <code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.algorithm.ADD_STRATEGY</span></code>. Once registered, the module can be configured in the configuration file using the registered name.</p>
</section>
<section id="step-1-2-implement-advantagefn">
<h4>Step 1.2: Implement <code class="docutils literal notranslate"><span class="pre">AdvantageFn</span></code><a class="headerlink" href="#step-1-2-implement-advantagefn" title="Link to this heading"></a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This step can be skipped if you have implemented <code class="docutils literal notranslate"><span class="pre">AddStrategy</span></code> as shown above.
The <code class="docutils literal notranslate"><span class="pre">AdvantageFn</span></code> is mainly used for per-sample advantage calculation, and not recommended for group-based advantage calculation.</p>
</div>
<p>The <a class="reference internal" href="../build_api/trinity.algorithm.html#trinity.algorithm.AdvantageFn" title="trinity.algorithm.AdvantageFn"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.algorithm.AdvantageFn</span></code></a> interface, which mainly includes two methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__call__</span></code>: Calculates advantages and returns based on input experience data, records observable metrics during the calculation process, and returns the experience data containing advantages and returns as well as a metrics dictionary. The input experience data format is <a class="reference external" href="https://github.com/volcengine/verl">verl</a>’s <code class="docutils literal notranslate"><span class="pre">DataProto</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default_args</span></code>: Returns default initialization parameters in dictionary form, which will be used by default when users don’t specify initialization parameters in the configuration file.</p></li>
</ul>
<p>After implementation, you need to register this module through <code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.algorithm.ADVANTAGE_FN</span></code>. Once registered, the module can be configured in the configuration file using the registered name.</p>
<p>Here’s an implementation example for the OPMD algorithm’s Advantage Fn:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># trinity/algorithm/advantage_fn/opmd.py</span>
<span class="c1"># import some modules</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">trinity.algorithm.advantage_fn</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADVANTAGE_FN</span><span class="p">,</span> <span class="n">AdvantageFn</span>


<span class="nd">@ADVANTAGE_FN</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="s2">&quot;opmd&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OPMDAdvantageFn</span><span class="p">(</span><span class="n">AdvantageFn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;OPMD advantage computation&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">opmd_baseline</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
        <span class="n">tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opmd_baseline</span> <span class="o">=</span> <span class="n">opmd_baseline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exps</span><span class="p">:</span> <span class="n">DataProto</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">DataProto</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
        <span class="c1"># calculate advantages and returns based on the exps</span>

        <span class="c1"># record some metrics</span>

        <span class="k">return</span> <span class="n">exps</span><span class="p">,</span> <span class="n">metrics</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_args</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;opmd_baseline&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tau&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="step-1-3-implement-policylossfn">
<h4>Step 1.3: Implement <code class="docutils literal notranslate"><span class="pre">PolicyLossFn</span></code><a class="headerlink" href="#step-1-3-implement-policylossfn" title="Link to this heading"></a></h4>
<p>Developers need to implement the <a class="reference internal" href="../build_api/trinity.algorithm.html#trinity.algorithm.PolicyLossFn" title="trinity.algorithm.PolicyLossFn"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.algorithm.PolicyLossFn</span></code></a> interface, which is similar to <code class="docutils literal notranslate"><span class="pre">AdvantageFn</span></code> and includes two methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__call__</span></code>: Calculates the loss based on input parameters. Unlike <code class="docutils literal notranslate"><span class="pre">AdvantageFn</span></code>, the input parameters here are all <code class="docutils literal notranslate"><span class="pre">torch.Tensor</span></code>. This interface automatically scans the parameter list of the <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method and converts it to the corresponding fields in the experience data. Therefore, please write all tensor names needed for loss calculation directly in the parameter list, rather than selecting parameters from <code class="docutils literal notranslate"><span class="pre">kwargs</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default_args</span></code>: Returns default initialization parameters in dictionary form, which will be used by default when users don’t specify initialization parameters in the configuration file.</p></li>
</ul>
<p>Similarly, after implementation, you need to register this module through <code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.algorithm.POLICY_LOSS_FN</span></code>.</p>
<p>Here’s an implementation example for the OPMD algorithm’s Policy Loss Fn. Since OPMD’s Policy Loss only requires logprob, action_mask, and advantages, only these three items are specified in the parameter list of the <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@POLICY_LOSS_FN</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="s2">&quot;opmd&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OPMDPolicyLossFn</span><span class="p">(</span><span class="n">PolicyLossFn</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">logprob</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">action_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">advantages</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
        <span class="n">pg_losses</span> <span class="o">=</span> <span class="o">-</span><span class="n">advantages</span> <span class="o">*</span> <span class="n">logprob</span>
        <span class="n">opmd_loss</span> <span class="o">=</span> <span class="n">masked_mean</span><span class="p">(</span><span class="n">pg_losses</span><span class="p">,</span> <span class="n">action_mask</span><span class="p">)</span>
        <span class="n">opmd_loss</span> <span class="o">=</span> <span class="n">opmd_loss</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>  <span class="c1"># for regularization (w.r.t. current pi_theta)</span>
        <span class="k">return</span> <span class="n">opmd_loss</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;opmd_loss&quot;</span><span class="p">:</span> <span class="n">opmd_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_args</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;tau&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="step-2-register-your-algorithm">
<h3>Step 2: Register Your Algorithm<a class="headerlink" href="#step-2-register-your-algorithm" title="Link to this heading"></a></h3>
<p>The above steps implement the components needed for the algorithm, but these components are scattered and need to be configured in multiple places to take effect.</p>
<p>To simplify configuration, Trinity-RFT provides <a class="reference internal" href="../build_api/trinity.algorithm.html#trinity.algorithm.AlgorithmType" title="trinity.algorithm.AlgorithmType"><code class="xref py py-class docutils literal notranslate"><span class="pre">trinity.algorithm.AlgorithmType</span></code></a> to describe a complete algorithm and registers it in , enabling one-click configuration.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">AlgorithmType</span></code> class includes the following attributes and methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">use_critic</span></code>: Whether to use the Critic model</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">use_reference</span></code>: Whether to use the Reference model</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compute_advantage_in_trainer</span></code>: Whether to calculate Advantages in Trainer; if False, the <code class="docutils literal notranslate"><span class="pre">AdvantageFn</span></code> call in trainer will be skipped</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">can_balance_batch</span></code>: Whether the algorithm allows automatic balancing when splitting a batch into microbatches (which permute the order of samples)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">schema</span></code>: The format of experience data corresponding to the algorithm</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default_config</span></code>: Gets the default configuration of the algorithm, which will override attributes with the same name in <code class="docutils literal notranslate"><span class="pre">ALGORITHM_TYPE</span></code></p></li>
</ul>
<p>Similarly, after implementation, you need to register this module through <code class="docutils literal notranslate"><span class="pre">ALGORITHM_TYPE</span></code>.</p>
<p>Below is the implementation for the OPMD algorithm.
Since the OPMD algorithm doesn’t need to use the Critic model, <code class="docutils literal notranslate"><span class="pre">use_critic</span></code> is set to <code class="docutils literal notranslate"><span class="pre">False</span></code>.
The dictionary returned by the <code class="docutils literal notranslate"><span class="pre">default_config</span></code> method indicates that OPMD will use the <code class="docutils literal notranslate"><span class="pre">opmd</span></code> type <code class="docutils literal notranslate"><span class="pre">AdvantageFn</span></code> and <code class="docutils literal notranslate"><span class="pre">PolicyLossFn</span></code> implemented in Step 1, will not apply KL Penalty on rewards, but will add a <code class="docutils literal notranslate"><span class="pre">k2</span></code> type KL loss when calculating the final loss.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@ALGORITHM_TYPE</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="s2">&quot;opmd&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OPMDAlgorithm</span><span class="p">(</span><span class="n">AlgorithmType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;OPMD algorithm.&quot;&quot;&quot;</span>

    <span class="n">use_critic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">use_reference</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">compute_advantage_in_trainer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">can_balance_batch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">schema</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">ExperienceModel</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;repeat_times&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;add_strategy&quot;</span><span class="p">:</span> <span class="s2">&quot;opmd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sample_strategy&quot;</span><span class="p">:</span> <span class="s2">&quot;warmup&quot;</span><span class="p">,</span>
            <span class="s2">&quot;policy_loss_fn&quot;</span><span class="p">:</span> <span class="s2">&quot;opmd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;advantage_fn&quot;</span><span class="p">:</span> <span class="s2">&quot;opmd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kl_penalty_fn&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kl_loss_fn&quot;</span><span class="p">:</span> <span class="s2">&quot;k2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;entropy_loss_fn&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="p">}</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="step-3-use-your-algorithm">
<h3>Step 3: Use Your Algorithm<a class="headerlink" href="#step-3-use-your-algorithm" title="Link to this heading"></a></h3>
<p>After completing all the above steps, you can use the newly registered algorithm through a YAML configuration file.</p>
<p>For default configurations, you just need to add the following content to your <code class="docutils literal notranslate"><span class="pre">config.yaml</span></code> file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># some other configs</span>
<span class="nt">algorithm</span><span class="p">:</span>
<span class="w">  </span><span class="nt">algorithm_type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;opmd&quot;</span>
<span class="c1"># some other configs</span>
</pre></div>
</div>
<p>If you need to modify certain parameters, you can simply add the corresponding parameters within the <code class="docutils literal notranslate"><span class="pre">algorithm</span></code> section. For example, if you need to modify <code class="docutils literal notranslate"><span class="pre">repeat_times</span></code> and the initialization parameters of <code class="docutils literal notranslate"><span class="pre">AdvantageFn</span></code> and <code class="docutils literal notranslate"><span class="pre">PolicyLossFn</span></code>, the modified <code class="docutils literal notranslate"><span class="pre">config.yaml</span></code> file would be as follows:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># some other configs</span>
<span class="nt">algorithm</span><span class="p">:</span>
<span class="w">  </span><span class="nt">algorithm_type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;opmd&quot;</span>
<span class="w">  </span><span class="nt">repeat_times</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
<span class="w">  </span><span class="nt">add_strategy_args</span><span class="p">:</span>
<span class="w">    </span><span class="nt">opmd_baseline</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;logavgexp&quot;</span>
<span class="w">    </span><span class="nt">tau</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.99</span>
<span class="w">  </span><span class="nt">policy_loss_fn_args</span><span class="p">:</span>
<span class="w">    </span><span class="nt">tau</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.99</span>
<span class="c1"># some other configs</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="adding-new-config-entries-for-the-config-generator-advanced">
<h2>Adding New Config Entries for the Config Generator (Advanced)<a class="headerlink" href="#adding-new-config-entries-for-the-config-generator-advanced" title="Link to this heading"></a></h2>
<section id="step-0-understanding-streamlit">
<h3>Step 0: Understanding Streamlit<a class="headerlink" href="#step-0-understanding-streamlit" title="Link to this heading"></a></h3>
<p>Before adding new parameters to the Config Generator page, it is essential to familiarize yourself with the relevant API and mechanisms of <a class="reference external" href="https://docs.streamlit.io/develop/api-reference">Streamlit</a>. This project primarily utilizes various input components from Streamlit and employs <code class="docutils literal notranslate"><span class="pre">st.session_state</span></code> to store user-input parameters.</p>
</section>
<section id="step-1-implement-new-config-entries">
<h3>Step 1: Implement New Config Entries<a class="headerlink" href="#step-1-implement-new-config-entries" title="Link to this heading"></a></h3>
<p>To illustrate the process of creating a new parameter setting for the Config Generator page, we will use <code class="docutils literal notranslate"><span class="pre">train_batch_size</span></code> as an example.</p>
<ol class="arabic">
<li><p>Determine the appropriate scope for the parameter. Currently, parameters are categorized into four files:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">trinity/manager/config_registry/buffer_config_manager.py</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trinity/manager/config_registry/explorer_config_manager.py</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trinity/manager/config_registry/model_config_manager.py</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trinity/manager/config_registry/trainer_config_manager.py</span></code></p></li>
</ul>
<p>In this case, <code class="docutils literal notranslate"><span class="pre">train_batch_size</span></code> should be placed in the <code class="docutils literal notranslate"><span class="pre">buffer_config_manager.py</span></code> file.</p>
</li>
<li><p>Create a parameter setting function using Streamlit. The function name must follow the convention of starting with ‘set_’, and the remainder of the name becomes the config name.</p></li>
<li><p>Decorate the parameter setting function with the <code class="docutils literal notranslate"><span class="pre">CONFIG_GENERATORS.register_config</span></code> decorator. This decorator requires the following information:</p>
<ul class="simple">
<li><p>Default value of the parameter</p></li>
<li><p>Visibility condition (if applicable)</p></li>
<li><p>Additional config parameters (if needed)</p></li>
</ul>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">CONFIG_GENERATORS.register_config</span></code> decorator automatically passes <code class="docutils literal notranslate"><span class="pre">key=config_name</span></code> as an argument to the registered configuration function. Ensure that your function accepts this keyword argument.</p>
</div>
<p>For <code class="docutils literal notranslate"><span class="pre">train_batch_size</span></code>, we will use the following settings:</p>
<ul class="simple">
<li><p>Default value: 96</p></li>
<li><p>Visibility condition: <code class="docutils literal notranslate"><span class="pre">lambda:</span> <span class="pre">st.session_state[&quot;trainer_gpu_num&quot;]</span> <span class="pre">&gt;</span> <span class="pre">0</span></code></p></li>
<li><p>Additional config: <code class="docutils literal notranslate"><span class="pre">{&quot;_train_batch_size_per_gpu&quot;:</span> <span class="pre">16}</span></code></p></li>
</ul>
<p>Here’s the complete code for the <code class="docutils literal notranslate"><span class="pre">train_batch_size</span></code> parameter:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@CONFIG_GENERATORS</span><span class="o">.</span><span class="n">register_config</span><span class="p">(</span>
    <span class="n">default_value</span><span class="o">=</span><span class="mi">96</span><span class="p">,</span>
    <span class="n">visible</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;trainer_gpu_num&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">other_configs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;_train_batch_size_per_gpu&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">},</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">set_train_batch_size</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
    <span class="n">trainer_gpu_num</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;trainer_gpu_num&quot;</span><span class="p">]</span>
    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;_train_batch_size_per_gpu&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;trainer_gpu_num&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_change</span><span class="p">():</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;_train_batch_size_per_gpu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">//</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;trainer_gpu_num&quot;</span><span class="p">],</span> <span class="mi">1</span>
        <span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span>
        <span class="s2">&quot;Train Batch Size&quot;</span><span class="p">,</span>
        <span class="n">min_value</span><span class="o">=</span><span class="n">trainer_gpu_num</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="n">trainer_gpu_num</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_str_for_train_batch_size</span><span class="p">(),</span>
        <span class="n">on_change</span><span class="o">=</span><span class="n">on_change</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>If the parameter requires validation, create a check function. For <code class="docutils literal notranslate"><span class="pre">train_batch_size</span></code>, we need to ensure it is divisible by <code class="docutils literal notranslate"><span class="pre">trainer_gpu_num</span></code>. If not, a warning should be displayed, and the parameter should be added to <code class="docutils literal notranslate"><span class="pre">unfinished_fields</span></code>.</p>
<p>Decorate the check function with the <code class="docutils literal notranslate"><span class="pre">CONFIG_GENERATORS.register_check</span></code> decorator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@CONFIG_GENERATORS</span><span class="o">.</span><span class="n">register_check</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">check_train_batch_size</span><span class="p">(</span><span class="n">unfinished_fields</span><span class="p">:</span> <span class="nb">set</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">%</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;trainer_gpu_num&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">unfinished_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_str_for_train_batch_size</span><span class="p">())</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">CONFIG_GENERATORS.register_check</span></code> decorator automatically receives <code class="docutils literal notranslate"><span class="pre">key=config_name</span></code> and <code class="docutils literal notranslate"><span class="pre">unfinished_fields=self.unfinished_fields</span></code> as arguments. Ensure your function accepts these keyword arguments.</p>
</div>
</section>
<section id="step-2-integrating-new-parameters-into-config-manager-py">
<h3>Step 2: Integrating New Parameters into <code class="docutils literal notranslate"><span class="pre">config_manager.py</span></code><a class="headerlink" href="#step-2-integrating-new-parameters-into-config-manager-py" title="Link to this heading"></a></h3>
<p>To successfully integrate new parameters into the <code class="docutils literal notranslate"><span class="pre">config_manager.py</span></code> file, please adhere to the following procedure:</p>
<ol class="arabic">
<li><p>Parameter Categorization:
Determine the appropriate section for the new parameter based on its functionality. The config generator page is structured into two primary modes:</p>
<ul class="simple">
<li><p>Beginner Mode: Comprises “Essential Configs” and “Important Configs” sections.</p></li>
<li><p>Expert Mode: Includes “Model”, “Buffer”, “Explorer and Synchronizer”, and “Trainer” sections.</p></li>
</ul>
</li>
<li><p>Parameter Addition:
Incorporate the new parameter into the relevant section using the <code class="docutils literal notranslate"><span class="pre">self.get_configs</span></code> method within the <code class="docutils literal notranslate"><span class="pre">ConfigManager</span></code> class.</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ConfigManager</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_expert_buffer_part</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_configs</span><span class="p">(</span><span class="s2">&quot;total_epochs&quot;</span><span class="p">,</span> <span class="s2">&quot;train_batch_size&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>YAML File Integration:
Locate the appropriate position for the new parameter within the YAML file structure. This should be done in the <code class="docutils literal notranslate"><span class="pre">generate_config</span></code> function and its associated sub-functions.</p></li>
<li><p>Parameter Value Assignment:
Utilize <code class="docutils literal notranslate"><span class="pre">st.session_state</span></code> to retrieve the parameter value from the config generator page and assign it to the corresponding field in the YAML.</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ConfigManager</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_gen_buffer_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buffer_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;train_batch_size&quot;</span><span class="p">],</span>
            <span class="c1"># Additional configuration parameters</span>
        <span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
<p>By meticulously following these steps, you can ensure that new parameters are successfully added to the Config Generator page and properly integrated into the configuration system. This process maintains the integrity and functionality of the configuration management framework.</p>
</section>
</section>
<hr class="docutils" />
<section id="check-code-style">
<h2>Check Code Style<a class="headerlink" href="#check-code-style" title="Link to this heading"></a></h2>
<p>Before submitting the code, make sure it passes the code style check. Follow these steps:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install code style checking tools</span>
<span class="nb">cd</span><span class="w"> </span>&lt;path_to_trinity_rft&gt;
<span class="c1"># bash</span>
pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.<span class="o">[</span>dev<span class="o">]</span>
<span class="c1"># zsh</span>
<span class="c1"># pip install -e .\[dev\]</span>

<span class="c1"># Run code style checks</span>
pre-commit<span class="w"> </span>run<span class="w"> </span>--all-files

<span class="c1"># Commit the code after all checks pass</span>
git<span class="w"> </span>commit<span class="w"> </span>-am<span class="w"> </span><span class="s2">&quot;create example workflow&quot;</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="example_data_functionalities.html" class="btn btn-neutral float-left" title="Data Processing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="trinity_configs.html" class="btn btn-neutral float-right" title="Configuration Guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Trinity-RFT Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>